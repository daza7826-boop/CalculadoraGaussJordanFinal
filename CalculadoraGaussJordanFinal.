package calculadoraGaussJordann;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import javax.swing.event.ChangeListener;
import java.awt.*;
import java.awt.event.*;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.List;

public class CalculadoraGaussJordanFinal extends JFrame {

    private static final double TOLERANCE = 1e-9;

    private final List<MatrizHistorial> historialMatrices = new ArrayList<>();
    private DefaultTableModel modeloTablaHistorial;
    private JTable tablaHistorial;
    private final JButton btnEditarHistorial;
    private final JButton btnBorrarHistorial;

    private JTextField[][] campos;
    private final JTextArea resultadoSistemaArea;
    private final JTextArea resultadoInversaArea;
    private final JComboBox<String> cmbTamano;
    private final JPanel panelMatrizContainer;
    private final JTabbedPane tabbedPane;

    private final List<List<JTextField>> camposEcuaciones = new ArrayList<>();
    private final List<JTextField> camposResultados = new ArrayList<>();
    private int tamanoActual = 3;

    private JPanel ecuacionFieldsPanel;
    private JTextField campoActivo;
    private JPanel panelTecladoFijo;

    private final Color COLOR_PRIMARIO = new Color(39, 174, 96);
    private final Color COLOR_FONDO = new Color(248, 249, 249);
    private final Color COLOR_BOTON_SISTEMA = new Color(52, 152, 219);
    private final Color COLOR_BOTON_INVERSA = new Color(243, 156, 18);
    private final Color COLOR_TEXTO_MATRIZ = new Color(44, 62, 80);
    private final Color COLOR_FONDO_B = new Color(232, 248, 245);
    private final Color COLOR_HISTORIAL = new Color(155, 89, 182);
    private final Color COLOR_BORRADO = new Color(231, 76, 60);
    private final Color COLOR_ACCION_SECUNDARIA = new Color(52, 73, 94);

    public CalculadoraGaussJordanFinal() {
        super("‚ú® Calculadora Gauss-Jordan: Historial y Matriz ‚ú®");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setSize(1200, 750);
        setLocationRelativeTo(null);
        getContentPane().setBackground(COLOR_FONDO);
        setLayout(new BorderLayout(10, 10));

        JPanel panelControl = new JPanel(new FlowLayout(FlowLayout.CENTER, 15, 8));
        panelControl.setBackground(Color.WHITE);
        panelControl.setBorder(BorderFactory.createEmptyBorder(8, 8, 8, 8));

        JLabel titulo = new JLabel("M√©todo de Eliminaci√≥n Gauss-Jordan");
        titulo.setFont(new Font("Segoe UI", Font.BOLD, 20));
        titulo.setForeground(COLOR_ACCION_SECUNDARIA);

        JLabel lblTamano = new JLabel("Matriz (NxN):");
        String[] tamanos = {"2x2","3x3","4x4","5x5","6x6","7x7","8x8","9x9","10x10"};
        cmbTamano = new JComboBox<>(tamanos);
        cmbTamano.setSelectedIndex(1);
        cmbTamano.setFont(new Font("Segoe UI", Font.BOLD, 14));
        cmbTamano.addActionListener(e -> cambiarTamanoMatriz());
        cmbTamano.setBackground(new Color(236,240,241));
        cmbTamano.setForeground(COLOR_TEXTO_MATRIZ);

        panelControl.add(titulo);
        panelControl.add(Box.createHorizontalStrut(20));
        panelControl.add(lblTamano);
        panelControl.add(cmbTamano);
        add(panelControl, BorderLayout.NORTH);

        tabbedPane = new JTabbedPane();
        tabbedPane.setFont(new Font("Segoe UI", Font.BOLD, 13));
        tabbedPane.setBackground(COLOR_FONDO);
        tabbedPane.addChangeListener((ChangeListener)e -> {
            if (panelTecladoFijo != null && panelTecladoFijo.isVisible() && tabbedPane.getSelectedIndex() != 0) {
                panelTecladoFijo.setVisible(false);
            }
        });

        // Panel ingreso
        JPanel panelIngresoCompleto = new JPanel(new BorderLayout(10,10));
        panelIngresoCompleto.setBackground(COLOR_FONDO);

        JPanel panelEntradaGeneral = new JPanel();
        panelEntradaGeneral.setLayout(new BoxLayout(panelEntradaGeneral, BoxLayout.Y_AXIS));
        panelEntradaGeneral.setBackground(COLOR_FONDO);
        panelEntradaGeneral.setBorder(BorderFactory.createEmptyBorder(10,10,10,10));

        JPanel panelEntradaTexto = new JPanel(new BorderLayout(5,5));
        panelEntradaTexto.setBackground(Color.WHITE);
        panelEntradaTexto.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(COLOR_PRIMARIO,1),
                "‚úçÔ∏è Escribir Ejercicio (Coeficientes por T√©rmino)",
                0,2,new Font("Segoe UI", Font.BOLD,14),COLOR_PRIMARIO));

        ecuacionFieldsPanel = new JPanel(new GridBagLayout());
        ecuacionFieldsPanel.setBackground(Color.WHITE);
        initializeInputPanel(tamanoActual, ecuacionFieldsPanel);

        JButton btnOrganizar = crearBoton("Transferir a Matriz", COLOR_ACCION_SECUNDARIA, Color.WHITE);
        btnOrganizar.addActionListener(e -> transferirAcuadros());

        JPanel panelBotonesEcuacion = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        panelBotonesEcuacion.setBackground(Color.WHITE);

        JButton btnEjemploEcuacion = crearBoton("üìã Completar y Ver Ejemplo", new Color(41,128,185), Color.WHITE);
        btnEjemploEcuacion.addActionListener(e -> cargarEjemplo(true));

        panelBotonesEcuacion.add(btnEjemploEcuacion);
        panelBotonesEcuacion.add(btnOrganizar);

        panelEntradaTexto.add(ecuacionFieldsPanel, BorderLayout.CENTER);
        panelEntradaTexto.add(panelBotonesEcuacion, BorderLayout.SOUTH);

        panelEntradaGeneral.add(panelEntradaTexto);
        panelEntradaGeneral.add(Box.createVerticalStrut(15));

        JPanel panelMatrizCoeficientes = new JPanel(new BorderLayout(10,10));
        panelMatrizCoeficientes.setBackground(Color.WHITE);
        panelMatrizCoeficientes.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(COLOR_BOTON_SISTEMA,1),
                "üî¢ Matriz de Coeficientes Aumentada",
                0,2,new Font("Segoe UI", Font.BOLD,14),COLOR_BOTON_SISTEMA));

        panelMatrizContainer = new JPanel(new GridBagLayout());
        panelMatrizContainer.setBackground(Color.WHITE);
        inicializarMatriz(tamanoActual);
        panelMatrizCoeficientes.add(panelMatrizContainer, BorderLayout.CENTER);
        panelEntradaGeneral.add(panelMatrizCoeficientes);

        JPanel panelAcciones = new JPanel(new FlowLayout(FlowLayout.CENTER, 15, 5));
        panelAcciones.setBackground(COLOR_FONDO);

        JButton btnResolverSistema = crearBoton("Resolver Sistema (Ax=b) y Guardar", COLOR_BOTON_SISTEMA, Color.WHITE);
        btnResolverSistema.addActionListener(e -> { guardarMatrizEnHistorial(); calcularAmbosResultados(0); });

        JButton btnCalcularInversa = crearBoton("Calcular Inversa (A‚Åª¬π) y Guardar", COLOR_BOTON_INVERSA, Color.WHITE);
        btnCalcularInversa.addActionListener(e -> { guardarMatrizEnHistorial(); calcularAmbosResultados(1); });

        JButton btnLimpiar = crearBoton("Limpiar Todo", COLOR_BORRADO, Color.WHITE);
        btnLimpiar.addActionListener(e -> limpiarCampos());

        JButton btnAbrirTeclado = crearBoton("‚å®Ô∏è Mostrar Teclado Num√©rico", COLOR_PRIMARIO, Color.WHITE);
        btnAbrirTeclado.addActionListener(e -> {
            if (campoActivo == null) {
                if (!camposEcuaciones.isEmpty() && !camposEcuaciones.get(0).isEmpty()) {
                    camposEcuaciones.get(0).get(0).requestFocusInWindow();
                    return;
                }
            }
            abrirTecladoNumerico();
        });

        panelAcciones.add(btnResolverSistema);
        panelAcciones.add(btnCalcularInversa);
        panelAcciones.add(btnAbrirTeclado);
        panelAcciones.add(btnLimpiar);

        JScrollPane scrollPanelIngreso = new JScrollPane(panelEntradaGeneral);
        scrollPanelIngreso.setBorder(null);

        panelTecladoFijo = crearTecladoFijo();
        panelTecladoFijo.setVisible(false);

        JPanel panelContenidoPrincipal = new JPanel(new BorderLayout(10,0));
        panelContenidoPrincipal.setBackground(COLOR_FONDO);
        panelContenidoPrincipal.add(scrollPanelIngreso, BorderLayout.CENTER);
        panelContenidoPrincipal.add(panelTecladoFijo, BorderLayout.EAST);

        panelIngresoCompleto.add(panelContenidoPrincipal, BorderLayout.CENTER);
        panelIngresoCompleto.add(panelAcciones, BorderLayout.SOUTH);

        tabbedPane.addTab("üî¢ Ingreso de Matriz", panelIngresoCompleto);

        // Pesta√±as resultado
        resultadoSistemaArea = new JTextArea();
        resultadoSistemaArea.setEditable(false);
        resultadoSistemaArea.setFont(new Font("Consolas", Font.PLAIN, 13));
        resultadoSistemaArea.setForeground(COLOR_TEXTO_MATRIZ);
        JScrollPane scrollResultadoSistema = new JScrollPane(resultadoSistemaArea);
        scrollResultadoSistema.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(COLOR_BOTON_SISTEMA,2),
                "üìù Soluci√≥n (Ax=b)",
                0,2,new Font("Segoe UI", Font.BOLD,14),COLOR_BOTON_SISTEMA));
        tabbedPane.addTab("üìù Soluci√≥n (Ax=b)", scrollResultadoSistema);

        resultadoInversaArea = new JTextArea();
        resultadoInversaArea.setEditable(false);
        resultadoInversaArea.setFont(new Font("Consolas", Font.PLAIN, 13));
        resultadoInversaArea.setForeground(COLOR_TEXTO_MATRIZ);
        JScrollPane scrollResultadoInversa = new JScrollPane(resultadoInversaArea);
        scrollResultadoInversa.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(COLOR_BOTON_INVERSA,2),
                "‚≠ê Detalle del Proceso y Matriz Inversa (A‚Åª¬π)",
                0,2,new Font("Segoe UI", Font.BOLD,14),COLOR_BOTON_INVERSA));
        tabbedPane.addTab("‚≠ê Inversa (A‚Åª¬π)", scrollResultadoInversa);

        // Historial
        JPanel panelHistorial = new JPanel(new BorderLayout(10,10));
        panelHistorial.setBackground(COLOR_FONDO);
        String[] columnas = {"ID","Tama√±o","Fecha y Hora","Matriz A","Vector b"};
        modeloTablaHistorial = new DefaultTableModel(columnas,0) {
            @Override public boolean isCellEditable(int r,int c){return false;}
        };
        tablaHistorial = new JTable(modeloTablaHistorial);
        tablaHistorial.setFont(new Font("Segoe UI", Font.PLAIN, 13));
        tablaHistorial.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        tablaHistorial.setBackground(Color.WHITE);
        tablaHistorial.setFillsViewportHeight(true);
        tablaHistorial.setGridColor(new Color(200,200,200));
        tablaHistorial.getTableHeader().setFont(new Font("Segoe UI", Font.BOLD, 14));
        tablaHistorial.getTableHeader().setBackground(new Color(220,230,240));
        tablaHistorial.getTableHeader().setForeground(COLOR_TEXTO_MATRIZ);
        tablaHistorial.setRowHeight(30);
        tablaHistorial.getColumnModel().getColumn(0).setPreferredWidth(30);
        tablaHistorial.getColumnModel().getColumn(1).setPreferredWidth(50);
        tablaHistorial.getColumnModel().getColumn(2).setPreferredWidth(120);
        tablaHistorial.getColumnModel().getColumn(3).setPreferredWidth(250);
        tablaHistorial.getColumnModel().getColumn(4).setPreferredWidth(100);

        JScrollPane scrollHistorial = new JScrollPane(tablaHistorial);
        scrollHistorial.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(COLOR_HISTORIAL,2),
                "üìö Historial de C√°lculos",
                0,2,new Font("Segoe UI", Font.BOLD,14),COLOR_HISTORIAL));
        panelHistorial.add(scrollHistorial, BorderLayout.CENTER);

        JPanel panelBotonesHistorial = new JPanel(new FlowLayout(FlowLayout.CENTER,20,10));
        panelBotonesHistorial.setBackground(COLOR_FONDO);

        btnEditarHistorial = crearBoton("‚úèÔ∏è Editar/Cargar Matriz", new Color(52,152,219), Color.WHITE);
        btnEditarHistorial.addActionListener(e -> editarCargarMatriz());
        btnEditarHistorial.setEnabled(false);

        btnBorrarHistorial = crearBoton("üóëÔ∏è Borrar Selecci√≥n", COLOR_BORRADO, Color.WHITE);
        btnBorrarHistorial.addActionListener(e -> borrarRegistroHistorial());
        btnBorrarHistorial.setEnabled(false);

        panelBotonesHistorial.add(btnEditarHistorial);
        panelBotonesHistorial.add(btnBorrarHistorial);
        panelHistorial.add(panelBotonesHistorial, BorderLayout.SOUTH);
        tabbedPane.addTab("üìö Historial", panelHistorial);

        tablaHistorial.getSelectionModel().addListSelectionListener(e -> {
            boolean isSelected = tablaHistorial.getSelectedRow() != -1;
            btnEditarHistorial.setEnabled(isSelected);
            btnBorrarHistorial.setEnabled(isSelected);
        });

        add(tabbedPane, BorderLayout.CENTER);
    }

    /* ---------- LOGICA DE HISTORIAL ---------- */
    private void guardarMatrizEnHistorial() {
        int n = tamanoActual;
        double[][] matrizDatos = new double[n][n+1];
        try {
            for (int i=0;i<n;i++) for (int j=0;j<n+1;j++) {
                String text = campos[i][j].getText();
                matrizDatos[i][j] = text.isEmpty() ? 0.0 : Double.parseDouble(text);
            }
            MatrizHistorial reg = new MatrizHistorial(matrizDatos,n,new Date());
            historialMatrices.add(reg);
            actualizarTablaHistorial(reg);
        } catch (NumberFormatException ignored){}
    }

    private void actualizarTablaHistorial(MatrizHistorial registro){
        String matrizA = registro.matrizToString(0, registro.getTamano());
        String vectorB = registro.matrizToString(registro.getTamano(), 1);
        Vector<Object> fila = new Vector<>();
        fila.add(historialMatrices.size());
        fila.add(registro.getTamano()+"x"+registro.getTamano());
        fila.add(new SimpleDateFormat("dd/MM/yy hh:mm:ss a").format(registro.getFecha()));
        fila.add(matrizA);
        fila.add(vectorB);
        modeloTablaHistorial.addRow(fila);
    }

    private void editarCargarMatriz(){
        int filaSeleccionada = tablaHistorial.getSelectedRow();
        if (filaSeleccionada==-1) return;
        MatrizHistorial registro = historialMatrices.get(filaSeleccionada);
        int n = registro.getTamano();
        double[][] datos = registro.getMatriz();
        cmbTamano.setSelectedItem(n+"x"+n);
        // limpiar campos ecuaciones
        for (List<JTextField> fila : camposEcuaciones) for (JTextField c: fila) c.setText("");
        for (JTextField c: camposResultados) c.setText("");
        DecimalFormat df = new DecimalFormat("0.#####");
        for (int i=0;i<n;i++) for (int j=0;j<n+1;j++) campos[i][j].setText(df.format(datos[i][j]));
        tabbedPane.setSelectedIndex(0);
        JOptionPane.showMessageDialog(this, "Matriz cargada de " + n + "x" + n + " en la pesta√±a 'Ingreso de Matriz'.", "Carga Exitosa", JOptionPane.INFORMATION_MESSAGE);
    }

    private void borrarRegistroHistorial(){
        int filaSeleccionada = tablaHistorial.getSelectedRow();
        if (filaSeleccionada==-1) return;
        int conf = JOptionPane.showConfirmDialog(this,"¬øEst√°s seguro de que quieres eliminar este registro del historial?","Confirmar Borrado",JOptionPane.YES_NO_OPTION);
        if (conf==JOptionPane.YES_OPTION){
            historialMatrices.remove(filaSeleccionada);
            modeloTablaHistorial.removeRow(filaSeleccionada);
            for (int i=0;i<modeloTablaHistorial.getRowCount();i++) modeloTablaHistorial.setValueAt(i+1,i,0);
            JOptionPane.showMessageDialog(this,"Registro eliminado con √©xito.","Borrado",JOptionPane.INFORMATION_MESSAGE);
        }
    }

    /* ---------- UTILIDADES UI ---------- */
    private JButton crearBoton(String texto, Color fondo, Color textoColor){
        JButton b = new JButton(texto);
        b.setFont(new Font("Segoe UI", Font.BOLD, 14));
        b.setBackground(fondo);
        b.setForeground(textoColor);
        b.setFocusPainted(false);
        b.setBorder(BorderFactory.createEmptyBorder(8,15,8,15));
        return b;
    }

    /* ---------- PANEL DE ECUACIONES (entrada) ---------- */
    private void cargarEjemplo(boolean forceTransfer){
        int n = tamanoActual;
        double[][] ejemplo;
        if (n==3){
            ejemplo = new double[][]{
                    {-1.0,6.0,1.0,8.0},
                    {3.0,2.0,8.0,3.0},
                    {9.0,5.0,7.0,9.0}
            };
        } else {
            ejemplo = new double[n][n+1];
            Random r = new Random();
            for (int i=0;i<n;i++) for (int j=0;j<n+1;j++){
                int num = r.nextInt(19)-9; if (num==0) num = r.nextBoolean()?1:-1;
                ejemplo[i][j]=num;
            }
        }
        DecimalFormat df = new DecimalFormat("0.#");
        if (tamanoActual==n) limpiarCampos();
        for (int i=0;i<n;i++){
            for (int j=0;j<n;j++){
                double num = ejemplo[i][j];
                String value = (Math.abs(num-Math.round(num))<1e-9) ? String.valueOf((int)Math.round(num)) : df.format(num);
                camposEcuaciones.get(i).get(j).setText(value);
            }
            double numB = ejemplo[i][n];
            String valueB = (Math.abs(numB-Math.round(numB))<1e-9) ? String.valueOf((int)Math.round(numB)) : df.format(numB);
            camposResultados.get(i).setText(valueB);
        }
        if (forceTransfer) transferirAcuadros();
    }

    private void cambiarTamanoMatriz(){
        String seleccion = (String)cmbTamano.getSelectedItem();
        int nuevo = Integer.parseInt(seleccion.substring(0, seleccion.indexOf('x')));
        if (nuevo!=tamanoActual){
            tamanoActual = nuevo;
            if (ecuacionFieldsPanel!=null) initializeInputPanel(tamanoActual, ecuacionFieldsPanel);
            inicializarMatriz(tamanoActual);
        }
    }

    private void initializeInputPanel(int n, JPanel containerPanel){
        containerPanel.removeAll();
        camposEcuaciones.clear();
        camposResultados.clear();
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(6,6,6,6);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        String[] vars = {"X","Y","Z","X4","X5","X6","X7","X8","X9","X10"};
        for (int j=0;j<n;j++){
            JLabel lblVar = new JLabel(vars[j], SwingConstants.CENTER);
            lblVar.setFont(new Font("Segoe UI", Font.BOLD, 12));
            lblVar.setForeground(COLOR_TEXTO_MATRIZ);
            gbc.gridx = j; gbc.gridy = 0;
            containerPanel.add(lblVar, gbc);
        }
        JLabel lblB = new JLabel("B", SwingConstants.CENTER);
        lblB.setFont(new Font("Segoe UI", Font.BOLD, 12));
        lblB.setForeground(COLOR_BOTON_SISTEMA);
        gbc.gridx = n+1; gbc.gridy = 0;
        containerPanel.add(lblB, gbc);

        FocusListener focusListener = new FocusAdapter(){
            @Override public void focusGained(FocusEvent e){
                campoActivo = (JTextField)e.getComponent(); abrirTecladoNumerico();
            }
        };

        KeyListener keyListener = new KeyAdapter(){
            @Override public void keyPressed(KeyEvent e){ if (e.getKeyCode()==KeyEvent.VK_ENTER){ transferirAcuadros(); e.consume(); } }
        };

        for (int i=0;i<n;i++){
            List<JTextField> filaCampos = new ArrayList<>();
            for (int j=0;j<n;j++){
                JTextField campoCoef = new JTextField(5);
                campoCoef.setFont(new Font("Consolas", Font.PLAIN, 16));
                campoCoef.setHorizontalAlignment(JTextField.CENTER);
                campoCoef.addFocusListener(focusListener);
                campoCoef.addKeyListener(keyListener);
                filaCampos.add(campoCoef);
                gbc.gridx = j; gbc.gridy = i+1; containerPanel.add(campoCoef, gbc);
            }
            camposEcuaciones.add(filaCampos);
            JLabel eqLabel = new JLabel("=", SwingConstants.CENTER);
            eqLabel.setFont(new Font("Segoe UI", Font.BOLD, 18));
            gbc.gridx = n; gbc.gridy = i+1; containerPanel.add(eqLabel, gbc);

            JTextField resultadoField = new JTextField(5);
            resultadoField.setFont(new Font("Consolas", Font.PLAIN, 16));
            resultadoField.setHorizontalAlignment(JTextField.CENTER);
            resultadoField.setBackground(COLOR_FONDO_B);
            resultadoField.addFocusListener(focusListener);
            resultadoField.addKeyListener(keyListener);
            camposResultados.add(resultadoField);
            gbc.gridx = n+1; gbc.gridy = i+1; containerPanel.add(resultadoField, gbc);
        }
        containerPanel.revalidate(); containerPanel.repaint();
    }

    private void transferirAcuadros(){
        int n = tamanoActual;
        try {
            for (int i=0;i<n;i++){
                for (int j=0;j<n;j++){
                    String text = camposEcuaciones.get(i).get(j).getText().trim();
                    String valor = text.isEmpty() ? "0" : parseCoeficiente(text);
                    campos[i][j].setText(valor);
                }
                String textB = camposResultados.get(i).getText().trim();
                String valorB = textB.isEmpty() ? "0" : textB;
                Double.parseDouble(valorB); // validar
                campos[i][n].setText(valorB);
            }
        } catch (NumberFormatException ex){
            JOptionPane.showMessageDialog(this,"¬°ERROR! Formato de n√∫mero inv√°lido. Aseg√∫rate de solo usar n√∫meros v√°lidos o expresiones literales simples (x, -y, 2z).","Error",JOptionPane.ERROR_MESSAGE);
        } catch (Exception ex){
            JOptionPane.showMessageDialog(this,"Ocurri√≥ un error inesperado al transferir los datos: " + ex.getMessage(),"Error",JOptionPane.ERROR_MESSAGE);
        }
    }

    private String parseCoeficiente(String text) throws NumberFormatException {
        try { Double.parseDouble(text); return text; } catch (NumberFormatException ignored) {}
        String clean = text.toLowerCase().trim();
        if (clean.matches("^[a-z].*")) return "1";
        if (clean.matches("^\\-([a-z].*)$")) return "-1";
        String numberPart = clean.replaceAll("[a-z].*","").trim();
        if (numberPart.isEmpty() || numberPart.equals("+")) return "1";
        if (numberPart.equals("-")) return "-1";
        Double.parseDouble(numberPart);
        return numberPart;
    }

    /* ---------- PANEL MATRIZ (UI) ---------- */
    private void inicializarMatriz(int n){
        panelMatrizContainer.removeAll();
        JPanel panelMatrizTotal = new JPanel(new GridBagLayout());
        panelMatrizTotal.setBackground(Color.WHITE);
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(5,2,5,2);
        gbc.fill = GridBagConstraints.BOTH;
        int columnasTotales = n+1;
        String[] vars = {"X","Y","Z","X4","X5","X6","X7","X8","X9","X10"};
        for (int j=0;j<n;j++){
            JLabel lblVar = new JLabel(vars[j], SwingConstants.CENTER);
            lblVar.setFont(new Font("Segoe UI", Font.BOLD, 14));
            lblVar.setForeground(COLOR_TEXTO_MATRIZ);
            gbc.gridx=j; gbc.gridy=0; panelMatrizTotal.add(lblVar,gbc);
        }
        JLabel lblB = new JLabel("T√©rminos independientes", SwingConstants.CENTER);
        lblB.setFont(new Font("Segoe UI", Font.BOLD, 14));
        lblB.setForeground(COLOR_BOTON_SISTEMA);
        gbc.gridx = n+1; gbc.gridy=0; panelMatrizTotal.add(lblB,gbc);

        campos = new JTextField[n][columnasTotales];

        FocusListener focusListener = new FocusAdapter(){
            @Override public void focusGained(FocusEvent e){ campoActivo = (JTextField)e.getComponent(); abrirTecladoNumerico(); }
        };
        KeyListener keyListener = new KeyAdapter(){
            @Override public void keyPressed(KeyEvent e){ if (e.getKeyCode()==KeyEvent.VK_ENTER){ transferirAcuadros(); e.consume(); } }
        };

        for (int i=0;i<n;i++){
            for (int j=0;j<columnasTotales;j++){
                JTextField campo = new JTextField();
                campos[i][j]=campo;
                campo.setHorizontalAlignment(JTextField.CENTER);
                campo.setFont(new Font("Consolas", Font.BOLD, 16));
                campo.setPreferredSize(new Dimension(65,30));
                campo.setForeground(COLOR_TEXTO_MATRIZ);
                campo.addFocusListener(focusListener);
                campo.addKeyListener(keyListener);
                gbc.gridy = i+1;
                if (j < n){
                    gbc.gridx = j; panelMatrizTotal.add(campo,gbc);
                } else {
                    campo.setBackground(COLOR_FONDO_B);
                    JLabel separador = new JLabel("=", SwingConstants.CENTER);
                    separador.setFont(new Font("Segoe UI", Font.BOLD, 18));
                    separador.setForeground(COLOR_TEXTO_MATRIZ);
                    gbc.gridx = n; panelMatrizTotal.add(separador,gbc);
                    gbc.gridx = n+1; panelMatrizTotal.add(campo,gbc);
                }
            }
        }
        panelMatrizContainer.add(panelMatrizTotal, new GridBagConstraints());
        panelMatrizContainer.revalidate(); panelMatrizContainer.repaint();
    }

    private void limpiarCampos(){
        for (int i=0;i<tamanoActual;i++) for (int j=0;j<tamanoActual+1;j++) campos[i][j].setText("");
        for (List<JTextField> fila: camposEcuaciones) for (JTextField c: fila) c.setText("");
        for (JTextField c: camposResultados) c.setText("");
        resultadoSistemaArea.setText(""); resultadoInversaArea.setText("");
        tabbedPane.setSelectedIndex(0); campoActivo = null;
        if (panelTecladoFijo!=null && panelTecladoFijo.isVisible()) panelTecladoFijo.setVisible(false);
    }

    private void abrirTecladoNumerico(){ if (panelTecladoFijo!=null) panelTecladoFijo.setVisible(true); }

    /* ---------- NAVEGACION ENTRE CAMPOS ---------- */
    private void navegarAlSiguienteCampo(){
        if (campoActivo==null) return;
        int n = tamanoActual;
        for (int i=0;i<n;i++){
            List<JTextField> fila = camposEcuaciones.get(i);
            for (int j=0;j<n;j++) if (fila.get(j)==campoActivo){
                if (j<n-1) { fila.get(j+1).requestFocusInWindow(); return; }
                else { camposResultados.get(i).requestFocusInWindow(); return; }
            }
            if (camposResultados.get(i)==campoActivo) { if (i<n-1) { camposEcuaciones.get(i+1).get(0).requestFocusInWindow(); return; } }
        }
        int colTotal = n+1;
        for (int i=0;i<n;i++) for (int j=0;j<colTotal;j++) if (campos[i][j]==campoActivo){
            if (j<colTotal-1) { campos[i][j+1].requestFocusInWindow(); return; }
            else if (i<n-1) { campos[i+1][0].requestFocusInWindow(); return; }
            else { transferirAcuadros(); if (panelTecladoFijo!=null && panelTecladoFijo.isVisible()) panelTecladoFijo.setVisible(false); return; }
        }
        KeyboardFocusManager.getCurrentKeyboardFocusManager().focusNextComponent();
    }

    private void navegarAnteriorCampo(){
        if (campoActivo==null) return;
        int n = tamanoActual; int colTotal = n+1;
        for (int i=0;i<n;i++) for (int j=0;j<colTotal;j++) if (campos[i][j]==campoActivo){
            if (j>0){ campos[i][j-1].requestFocusInWindow(); return; }
            else if (i>0){ campos[i-1][colTotal-1].requestFocusInWindow(); return; }
            return;
        }
        for (int i=0;i<n;i++){
            List<JTextField> fila = camposEcuaciones.get(i);
            for (int j=0;j<n;j++) if (fila.get(j)==campoActivo){
                if (j>0){ fila.get(j-1).requestFocusInWindow(); return; }
                else if (i>0){ camposResultados.get(i-1).requestFocusInWindow(); return; }
                return;
            }
            if (camposResultados.get(i)==campoActivo){ fila.get(n-1).requestFocusInWindow(); return; }
        }
    }

    /* ---------- C√ÅLCULO (Gauss-Jordan) ---------- */
    private void calcularAmbosResultados(int tabIndexToSelect){
        resolverSistema(); resolverInversa();
        tabbedPane.setSelectedIndex(tabIndexToSelect+1);
    }

    private void resolverSistema(){
        int n = tamanoActual;
        double[][] matriz = new double[n][n+1];
        boolean b_vacio = true;
        try {
            for (int i=0;i<n;i++){
                for (int j=0;j<n;j++){
                    String t = campos[i][j].getText();
                    matriz[i][j] = t.isEmpty() ? 0.0 : Double.parseDouble(t);
                }
                String tB = campos[i][n].getText();
                double vB = tB.isEmpty() ? 0.0 : Double.parseDouble(tB);
                matriz[i][n] = vB;
                if (Math.abs(vB) > TOLERANCE) b_vacio = false;
            }
        } catch (NumberFormatException ex){
            resultadoSistemaArea.setText("¬°ERROR! Formato de n√∫mero inv√°lido en la matriz. Aseg√∫rate de solo usar n√∫meros.");
            return;
        }
        if (b_vacio){ _calcularInversa(resultadoSistemaArea, true); return; }
        double[][] copia = copiarMatriz(matriz);
        StringBuilder proceso = new StringBuilder();
        proceso.append("====================================\n  Resolviendo Sistema (Ax=b)\n====================================\n");
        proceso.append("Matriz Aumentada Inicial [A | b]:\n").append(matrizToString(copia,n)).append("\n\n");
        double[] sol = gaussJordan(copia, n, true, proceso);
        proceso.append("\n\n====================================\n");
        if (sol!=null){
            proceso.append("  Matriz Final en Forma Reducida [I | Soluci√≥n]\n====================================\n");
            proceso.append(matrizToString(copia,n)).append("\n\n====================================\n       Soluciones Finales\n====================================\n");
            DecimalFormat df = new DecimalFormat("0.######");
            for (int i=0;i<sol.length;i++) proceso.append("x").append(i+1).append(" = ").append(df.format(sol[i])).append("\n");
        } else {
            proceso.append("Sistema sin Soluci√≥n √önica\n====================================\nEl sistema es inconsistente o tiene infinitas soluciones.");
        }
        resultadoSistemaArea.setText(proceso.toString());
        resultadoSistemaArea.setCaretPosition(0);
    }

    private void resolverInversa(){ _calcularInversa(resultadoInversaArea, false); }

    private void _calcularInversa(JTextArea area, boolean showSystemOverride){
        int n = tamanoActual;
        double[][] matrizAumentada = new double[n][2*n];
        try {
            for (int i=0;i<n;i++){
                for (int j=0;j<n;j++){
                    String t = campos[i][j].getText();
                    matrizAumentada[i][j] = t.isEmpty() ? 0.0 : Double.parseDouble(t);
                }
                matrizAumentada[i][n+i]=1.0;
            }
        } catch (NumberFormatException ex){
            area.setText("¬°ERROR! Formato de n√∫mero inv√°lido en la matriz A. Aseg√∫rate de solo usar n√∫meros.");
            return;
        }
        StringBuilder proceso = new StringBuilder();
        proceso.append("====================================\n");
        if (showSystemOverride){
            proceso.append("‚ö†Ô∏è C√ÅLCULO MODIFICADO POR AUSENCIA DE B\n====================================\nDebido a que la columna de 'T√©rminos Independientes' (b) estaba vac√≠a,\nel sistema ha asumido que se desea calcular la *Matriz Inversa* (A‚Åª¬π).\n====================================\n");
        } else {
            proceso.append("  Calculando Matriz Inversa (A‚Åª¬π)\n====================================\n");
        }
        proceso.append("Matriz Aumentada Inicial [A | I]:\n").append(matrizToString(matrizAumentada,n)).append("\n\n");
        double[] resultadoExito = gaussJordan(matrizAumentada, n, false, proceso);
        boolean exito = resultadoExito != null;
        proceso.append("\n\n====================================\n");
        if (exito){
            proceso.append("  Matriz Final [I | A‚Åª¬π]\n====================================\n");
            proceso.append(matrizToString(matrizAumentada,n)).append("\n\n====================================\n       Matriz Inversa (A‚Åª¬π)\n====================================\n");
            proceso.append(extraerInversa(matrizAumentada,n));
        } else {
            proceso.append("Matriz No Invertible (Singular)\n====================================\nEl determinante es cero. La matriz no tiene inversa.");
        }
        area.setText(proceso.toString());
        area.setCaretPosition(0);
    }

    private double[][] copiarMatriz(double[][] original){
        double[][] copia = new double[original.length][original[0].length];
        for (int i=0;i<original.length;i++) System.arraycopy(original[i],0,copia[i],0,original[i].length);
        return copia;
    }

    private String matrizToString(double[][] M, int n){
        StringBuilder sb = new StringBuilder();
        DecimalFormat df = new DecimalFormat("0.#####");
        int colTotal = M[0].length;
        int anchoCelda = 10;
        String lineaSeparacion = "+";
        for (int j=0;j<colTotal;j++){
            lineaSeparacion += String.format("%" + anchoCelda + "s","").replace(' ','-');
            if (j==n-1 && colTotal==n+1) lineaSeparacion += "|"; else if (j==n-1 && colTotal==2*n) lineaSeparacion += "||"; else lineaSeparacion += "+";
        }
        if (colTotal==2*n) lineaSeparacion = lineaSeparacion.substring(0,lineaSeparacion.length()-1) + "+";
        if (colTotal==n+1) lineaSeparacion = lineaSeparacion.replace("|+","+");
        for (int i=0;i<n;i++){
            sb.append(lineaSeparacion).append("\n").append("|");
            for (int j=0;j<colTotal;j++){
                double valor = Math.abs(M[i][j]) < TOLERANCE ? 0.0 : M[i][j];
                String val = df.format(valor);
                sb.append(String.format("%" + anchoCelda + "s", val));
                if (j==n-1 && colTotal==n+1) sb.append(" |"); else if (j==n-1 && colTotal==2*n) sb.append(" ||"); else sb.append("|");
            }
            sb.append("\n");
        }
        sb.append(lineaSeparacion).append("\n");
        return sb.toString();
    }

    private String extraerInversa(double[][] M, int n){
        StringBuilder sb = new StringBuilder();
        DecimalFormat df = new DecimalFormat("0.#####");
        int anchoCelda = 10;
        String lineaSeparacion = "+";
        for (int j=n;j<2*n;j++){ lineaSeparacion += String.format("%" + anchoCelda + "s","").replace(' ','-') + "+"; }
        for (int i=0;i<n;i++){
            sb.append(lineaSeparacion).append("\n").append("|");
            for (int j=n;j<2*n;j++){
                double valor = Math.abs(M[i][j]) < TOLERANCE ? 0.0 : M[i][j];
                sb.append(String.format("%" + anchoCelda + "s", df.format(valor))).append("|");
            }
            sb.append("\n");
        }
        sb.append(lineaSeparacion).append("\n");
        return sb.toString();
    }

    private double[] gaussJordan(double[][] M, int n, boolean isSistema, StringBuilder proceso){
        DecimalFormat df = new DecimalFormat("0.#####");
        int colTotal = M[0].length;
        for (int k=0;k<n;k++){
            proceso.append("\n--- FASE ").append(k+1).append(": Pivote en (").append(k+1).append(", ").append(k+1).append(") ---\n\n");
            int i_max = k;
            for (int i=k+1;i<n;i++) if (Math.abs(M[i][k])>Math.abs(M[i_max][k])) i_max = i;
            if (i_max!=k){
                double[] temp = M[k]; M[k] = M[i_max]; M[i_max] = temp;
                proceso.append("-> Operaci√≥n: Intercambio F").append(k+1).append(" <-> F").append(i_max+1).append("\n");
                proceso.append(matrizToString(M,n)).append("\n\n");
            }
            if (Math.abs(M[k][k]) < TOLERANCE){ proceso.append("--- Matriz Singular o Sistema Inconsistente (Divisi√≥n por cero) --- \n"); return null; }
            double divisor = M[k][k];
            if (Math.abs(divisor-1.0) > TOLERANCE){
                for (int j=k;j<colTotal;j++) M[k][j] /= divisor;
                proceso.append("-> Operaci√≥n: Normalizar F").append(k+1).append(" = F").append(k+1).append(" / ").append(df.format(divisor)).append("\n");
                proceso.append(matrizToString(M,n)).append("\n\n");
            }
            for (int i=0;i<n;i++) if (i!=k){
                double factor = M[i][k];
                if (Math.abs(factor) > TOLERANCE){
                    for (int j=k;j<colTotal;j++) M[i][j] -= factor * M[k][j];
                    proceso.append("-> Operaci√≥n: Eliminar F").append(i+1).append(" = F").append(i+1).append(" - ").append(df.format(factor)).append(" * F").append(k+1).append("\n");
                    proceso.append(matrizToString(M,n)).append("\n\n");
                }
            }
            if (proceso.length()>=2 && proceso.substring(proceso.length()-2).equals("\n\n")) proceso.setLength(proceso.length()-2);
        }
        if (isSistema){
            double[] soluciones = new double[n];
            for (int i=0;i<n;i++) soluciones[i] = M[i][n];
            return soluciones;
        }
        return new double[n]; // √©xito para inversa (no usado directamente)
    }

    /* ---------- TECLADO NUMERICO FIJO ---------- */
    private JPanel crearTecladoFijo(){
        final Color COLOR_TECLADO_FONDO = new Color(33,33,33);
        final Color COLOR_NUMERO = new Color(255,255,255);
        final Color COLOR_BOTON_NUMERO = new Color(66,66,66);
        final Color COLOR_OPERADOR = new Color(255,140,0);

        JPanel panelBotones = new JPanel(new GridLayout(4,4,5,5));
        panelBotones.setBorder(BorderFactory.createEmptyBorder(10,10,10,10));
        panelBotones.setBackground(COLOR_TECLADO_FONDO);

        String[] botones = {"7","8","9","Borrar","4","5","6","+","1","2","3","-","0",".","ENTER","X"};
        Font fontBotones = new Font("Segoe UI", Font.BOLD, 20);

        ActionListener tecladoListener = e -> {
            String comando = e.getActionCommand();
            JTextField campo = campoActivo;
            if (campo==null){
                if (!camposEcuaciones.isEmpty() && !camposEcuaciones.get(0).isEmpty()) {
                    camposEcuaciones.get(0).get(0).requestFocusInWindow();
                    campo = campoActivo;
                }
                if (campo==null) return;
            }
            String textoActual = campo.getText();
            int caretPos = campo.getCaretPosition();
            try {
                switch (comando){
                    case "0": case "1": case "2": case "3": case "4": case "5": case "6":
                    case "7": case "8": case "9":
                        campo.setText(textoActual.substring(0, caretPos) + comando + textoActual.substring(caretPos));
                        campo.setCaretPosition(caretPos+1);
                        SwingUtilities.invokeLater(this::navegarAlSiguienteCampo);
                        return;
                    case ".":
                        if (!textoActual.contains(".")){
                            campo.setText(textoActual.substring(0, caretPos) + comando + textoActual.substring(caretPos));
                            campo.setCaretPosition(caretPos+1);
                            SwingUtilities.invokeLater(this::navegarAlSiguienteCampo);
                        }
                        break;
                    case "+": case "-":
                        if (textoActual.isEmpty() && caretPos==0){ campo.setText(comando); campo.setCaretPosition(1); }
                        break;
                    case "Borrar":
                        if (caretPos>0){ campo.setText(textoActual.substring(0, caretPos-1) + textoActual.substring(caretPos)); campo.setCaretPosition(caretPos-1); }
                        break;
                    case "C":
                        campo.setText(""); panelTecladoFijo.setVisible(false);
                        break;
                    case "ENTER":
                        panelTecladoFijo.setVisible(false); transferirAcuadros(); return;
                    case "X":
                        panelTecladoFijo.setVisible(false); return;
                }
            } catch (Exception ignored){}
            campo.requestFocusInWindow();
        };

        for (String txt : botones){
            JButton b = new JButton(txt);
            b.setFont(fontBotones);
            b.setFocusPainted(false);
            b.addActionListener(tecladoListener);
            if (txt.matches("[0-9]") || txt.equals(".")){ b.setBackground(COLOR_BOTON_NUMERO); b.setForeground(COLOR_NUMERO); }
            else if (txt.equals("ENTER")){ b.setBackground(COLOR_OPERADOR); b.setForeground(Color.WHITE); }
            else if (txt.equals("Borrar") || txt.equals("C")){ b.setBackground(COLOR_OPERADOR.darker()); b.setForeground(Color.WHITE); }
            else { b.setBackground(COLOR_OPERADOR); b.setForeground(Color.WHITE); }
            panelBotones.add(b);
        }

        JPanel panelContenedor = new JPanel(new BorderLayout());
        JPanel buttonsWrapper = new JPanel(new BorderLayout());
        buttonsWrapper.setOpaque(false);
        buttonsWrapper.add(panelBotones, BorderLayout.CENTER);

        JPanel footer = new JPanel(new FlowLayout(FlowLayout.CENTER,8,6));
        footer.setOpaque(false);

        JButton btnLeft = new JButton("‚Üê");
        btnLeft.setFont(new Font("Segoe UI", Font.BOLD, 16));
        btnLeft.setFocusPainted(false);
        btnLeft.setBackground(new Color(52,152,219));
        btnLeft.setForeground(Color.WHITE);
        btnLeft.addActionListener(ev -> {
            SwingUtilities.invokeLater(() -> {
                Component owner = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
                if (owner instanceof JTextField) campoActivo = (JTextField) owner;
                if (campoActivo == null) {
                    outer1:
                    if (camposEcuaciones != null && !camposEcuaciones.isEmpty()) for (List<JTextField> fila : camposEcuaciones) for (JTextField tf : fila) if (tf != null) { campoActivo = tf; break outer1; }
                    if (campoActivo == null && campos != null && campos.length > 0) outer2:
                    for (int i=0;i<campos.length;i++) for (int j=0;j<campos[i].length;j++) if (campos[i][j]!=null){ campoActivo = campos[i][j]; break outer2; }
                }
                try { navegarAnteriorCampo(); } catch (Exception ignored){}
                Component nuevo = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
                if (nuevo instanceof JTextField){ campoActivo = (JTextField)nuevo; campoActivo.requestFocusInWindow(); campoActivo.selectAll(); }
            });
        });

        JButton btnRight = new JButton("‚Üí");
        btnRight.setFont(new Font("Segoe UI", Font.BOLD, 16));
        btnRight.setFocusPainted(false);
        btnRight.setBackground(new Color(52,152,219));
        btnRight.setForeground(Color.WHITE);
        btnRight.addActionListener(ev -> {
            SwingUtilities.invokeLater(() -> {
                Component owner = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
                if (owner instanceof JTextField) campoActivo = (JTextField) owner;
                if (campoActivo == null) {
                    outer3:
                    if (camposEcuaciones != null && !camposEcuaciones.isEmpty()) for (List<JTextField> fila : camposEcuaciones) for (JTextField tf : fila) if (tf != null){ campoActivo = tf; break outer3; }
                    if (campoActivo == null && campos != null && campos.length > 0) outer4:
                    for (int i=0;i<campos.length;i++) for (int j=0;j<campos[i].length;j++) if (campos[i][j]!=null){ campoActivo = campos[i][j]; break outer4; }
                }
                try { navegarAlSiguienteCampo(); } catch (Exception ignored){}
                Component nuevo = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
                if (nuevo instanceof JTextField){ campoActivo = (JTextField)nuevo; campoActivo.requestFocusInWindow(); campoActivo.selectAll(); }
            });
        });

        Dimension flechaSize = new Dimension(48,30);
        btnLeft.setPreferredSize(flechaSize);
        btnRight.setPreferredSize(flechaSize);
        footer.add(btnLeft); footer.add(btnRight);
        buttonsWrapper.add(footer, BorderLayout.SOUTH);
        panelContenedor.add(buttonsWrapper, BorderLayout.NORTH);

        panelContenedor.setBorder(BorderFactory.createTitledBorder(
                BorderFactory.createLineBorder(COLOR_PRIMARIO,1),
                "‚å®Ô∏è Teclado Num√©rico Fijo",
                0,2,new Font("Segoe UI", Font.BOLD,14),COLOR_PRIMARIO));
        panelContenedor.setBackground(COLOR_FONDO);
        panelContenedor.setPreferredSize(new Dimension(280,350));
        return panelContenedor;
    }

    private void configurarCierreConTeclado(){
        InputMap im = getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW);
        KeyStroke k = KeyStroke.getKeyStroke(KeyEvent.VK_MULTIPLY,0);
        String cerrar = "cerrarVentana";
        im.put(k,cerrar);
        getRootPane().getActionMap().put(cerrar, new AbstractAction(){ @Override public void actionPerformed(ActionEvent e){ dispose(); }});
    }

    /* ---------- CLASE INTERNA HISTORIAL ---------- */
    private static class MatrizHistorial {
        private final double[][] matriz;
        private final int tamano;
        private final Date fecha;
        public MatrizHistorial(double[][] matriz, int tamano, Date fecha){
            this.tamano=tamano; this.fecha=fecha;
            this.matriz = new double[tamano][tamano+1];
            for (int i=0;i<tamano;i++) System.arraycopy(matriz[i],0,this.matriz[i],0,tamano+1);
        }
        public double[][] getMatriz(){ return matriz; }
        public int getTamano(){ return tamano; }
        public Date getFecha(){ return fecha; }
        public String matrizToString(int startCol, int width){
            StringBuilder sb = new StringBuilder();
            DecimalFormat df = new DecimalFormat("0.##");
            for (int i=0;i<tamano;i++){
                sb.append("[");
                for (int j=0;j<width;j++){
                    double valor = matriz[i][startCol+j];
                    sb.append(df.format(valor));
                    if (j<width-1) sb.append(", ");
                }
                sb.append("]");
                if (i<tamano-1) sb.append(" | ");
            }
            return sb.toString();
        }
    }

    public static void main(String[] args){
        SwingUtilities.invokeLater(() -> {
            try { UIManager.setLookAndFeel("javax.swing.plaf.nimbus.NimbusLookAndFeel"); } catch (Exception ignored){}
            CalculadoraGaussJordanFinal app = new CalculadoraGaussJordanFinal();
            app.setVisible(true);
            app.configurarCierreConTeclado();
        });
    }
}
