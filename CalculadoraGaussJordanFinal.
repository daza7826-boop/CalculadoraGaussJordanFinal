package calculadoraGaussJordanFinal;

import javax.swing.*;
import javax.swing.event.ChangeListener;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.*;
import java.text.DecimalFormat;
import java.text.SimpleDateFormat;
import java.util.*;
import java.util.List;
import javax.imageio.ImageIO;
import java.io.IOException;
import java.net.URL;

public class CalculadoraGaussJordanFinal extends JFrame {
    private static final double TOL = 1e-9;
    private final List<MatrizHistorial> historial = new ArrayList<>();
    private DefaultTableModel modeloHist;
    private JTable tablaHist;
    private final JButton btnEditarHistorial, btnBorrarHistorial;
    private JTextField[][] campos;
    private JTextArea areaSistema, areaInversa;
    private final JComboBox<String> cmbTamano;
    private final JPanel panelMatrizContainer;
    private final JTabbedPane tabbedPane;
    private final List<List<JTextField>> camposEcu = new ArrayList<>();
    private final List<JTextField> camposB = new ArrayList<>();
    private int nActual = 3;
    private JPanel ecuacionPanel;
    private JTextField campoActivo;
    private JPanel panelTeclado;
    private final Color P = new Color(39,174,96), BG = new Color(248,249,249),
            S = new Color(52,152,219), I = new Color(243,156,18),
            TXT = new Color(44,62,80), FB = new Color(232,248,245),
            H = new Color(155,89,182), DEL = new Color(231,76,60),
            SEC = new Color(52,73,94);


    private class BackgroundPanel extends JPanel {
        private Image backgroundImage;

        public BackgroundPanel() {
            try {
                URL imageUrl = getClass().getResource("fondo calculadora.jpg"); 
                if (imageUrl != null) {
                    backgroundImage = ImageIO.read(imageUrl);
                } else {
                    System.err.println("Advertencia: La imagen 'fondo calculadora.jpg' no se encontr√≥ en el classpath. Usando color s√≥lido.");
                }
            } catch (IOException e) {
                System.err.println("Error al cargar la imagen de fondo: " + e.getMessage());
            }
            setLayout(new BorderLayout(8, 8));
            setOpaque(false);
        }
        @Override
        protected void paintComponent(Graphics g) {
            super.paintComponent(g);
            if (backgroundImage != null) {
                g.drawImage(backgroundImage, 0, 0, getWidth(), getHeight(), this);
            } else {
                g.setColor(new Color(44, 62, 80)); 
                g.fillRect(0, 0, getWidth(), getHeight());
            }
        }
    }
    
    public CalculadoraGaussJordanFinal() {
        super("‚ú® Calculadora Gauss-Jordan");
        setDefaultCloseOperation(EXIT_ON_CLOSE);
        setSize(900, 550);
        setLocationRelativeTo(null);

        // üÜï Crear el panel de fondo y establecerlo como ContentPane
        BackgroundPanel mainPanel = new BackgroundPanel();
        setContentPane(mainPanel); 

        // ‚ö†Ô∏è El layout del JFrame ahora se aplica al mainPanel
        mainPanel.setLayout(new BorderLayout(8,8));

        // NORTH (title + tama√±o)
        JPanel north = new JPanel(new FlowLayout(FlowLayout.CENTER,10,8));
        north.setOpaque(false); // Hacer transparente para ver el fondo
        JLabel titulo = new JLabel("M√©todo de Eliminaci√≥n Gauss-Jordan");
        titulo.setFont(new Font("Segoe UI", Font.BOLD,18)); titulo.setForeground(Color.WHITE); // Cambiar a blanco para que resalte en el fondo oscuro
        north.add(titulo); north.add(Box.createHorizontalStrut(16));
        JLabel labelTam = new JLabel("Matriz (NxN):"); labelTam.setForeground(Color.WHITE); // Cambiar a blanco
        north.add(labelTam); 
        String[] tam = {"2x2","3x3","4x4","5x5","6x6","7x7","8x8","9x9","10x10"};
        cmbTamano = new JComboBox<>(tam); cmbTamano.setSelectedIndex(1);
        cmbTamano.setFont(new Font("Segoe UI", Font.BOLD,13));
        cmbTamano.addActionListener(e -> cambiarTamano());
        north.add(cmbTamano);
        
        JPanel northWrapper = new JPanel(new GridBagLayout());
        northWrapper.setOpaque(false); // Hacer transparente
        northWrapper.add(north, new GridBagConstraints());
        mainPanel.add(northWrapper, BorderLayout.NORTH);

        // TABS
        tabbedPane = new JTabbedPane(); tabbedPane.setFont(new Font("Segoe UI", Font.BOLD,13));
        tabbedPane.setBackground(BG);
        tabbedPane.setOpaque(false); // Transparente para ver el fondo a trav√©s de los espacios
        tabbedPane.addChangeListener((ChangeListener)e -> { if (panelTeclado!=null && panelTeclado.isVisible() && tabbedPane.getSelectedIndex()!=0) panelTeclado.setVisible(false); });

        // INGRESO TAB
        JPanel ingreso = new JPanel(new BorderLayout(8,8)); 
        ingreso.setOpaque(false); // Hacer transparente
        JPanel entrada = new JPanel(); entrada.setLayout(new BoxLayout(entrada, BoxLayout.Y_AXIS));
        entrada.setOpaque(false); // Hacer transparente
        entrada.setBorder(BorderFactory.createEmptyBorder(1,8,8,8));

        // Ecuaciones (texto)
        JPanel texto = new JPanel(new BorderLayout(6,6)); 
        texto.setOpaque(false); // Hacer transparente
        texto.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(P,1),
                "‚úçÔ∏è Escribir Ejercicio (Coeficientes por T√©rmino)",0,2,new Font("Segoe UI",Font.BOLD,13),P));
        ecuacionPanel = new JPanel(new GridBagLayout()); 
        ecuacionPanel.setOpaque(false); // Hacer transparente
        initInputPanel(nActual, ecuacionPanel);
        texto.add(ecuacionPanel, BorderLayout.CENTER);
        JPanel btnsEq = new JPanel(new FlowLayout(FlowLayout.RIGHT)); 
        btnsEq.setOpaque(false); // Hacer transparente
        JButton btnEjemplo = btn("üìã Completar y Ver Ejemplo", new Color(41,128,185));
        btnEjemplo.addActionListener(a -> cargarEjemplo(true));
        JButton btnTrans = btn("Transferir a Matriz", SEC); btnTrans.addActionListener(a -> transferir());
        btnsEq.add(btnEjemplo); btnsEq.add(btnTrans);
        texto.add(btnsEq, BorderLayout.SOUTH);
        JPanel textoWrapper = new JPanel(new GridBagLayout()); 
        textoWrapper.setOpaque(false); // Hacer transparente
        textoWrapper.add(texto, new GridBagConstraints());
        entrada.add(textoWrapper); entrada.add(Box.createVerticalStrut(10));

        // Matriz Aumentada
        JPanel matr = new JPanel(new BorderLayout(6,6)); 
        matr.setOpaque(false); // Hacer transparente
        matr.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(S,1),
                "üî¢ Matriz de Coeficientes Aumentada",0,2,new Font("Segoe UI",Font.BOLD,13),S));
        panelMatrizContainer = new JPanel(new GridBagLayout()); 
        panelMatrizContainer.setOpaque(false); // Hacer transparente
        inicializarMatriz(nActual);
        matr.add(panelMatrizContainer, BorderLayout.CENTER);
        JPanel matrWrapper = new JPanel(new GridBagLayout()); 
        matrWrapper.setOpaque(false); // Hacer transparente
        matrWrapper.add(matr, new GridBagConstraints());
        entrada.add(matrWrapper);

        // Acciones
        JPanel acciones = new JPanel(new FlowLayout(FlowLayout.CENTER,12,6)); 
        acciones.setOpaque(false); // Hacer transparente
        JButton btnRes = btn("Resolver Sistema (Ax=b) y Guardar", S); btnRes.addActionListener(a->{guardarHist(); calcularAmbos(0);});
        JButton btnInv = btn("Calcular Inversa (A‚Åª¬π) y Guardar", I); btnInv.addActionListener(a->{guardarHist(); calcularAmbos(1);});
        JButton btnTecl = btn("‚å®Ô∏è Mostrar Teclado Num√©rico", P); btnTecl.addActionListener(a->{ if (campoActivo==null){ if (!camposEcu.isEmpty() && !camposEcu.get(0).isEmpty()) {camposEcu.get(0).get(0).requestFocusInWindow(); return;} } abrirTeclado();});
        JButton btnLim = btn("Limpiar Todo", DEL); btnLim.addActionListener(a->limpiar());
        acciones.add(btnRes); acciones.add(btnInv); acciones.add(btnTecl); acciones.add(btnLim);

        JScrollPane sp = new JScrollPane(entrada); sp.setBorder(null);
        // Hacemos el viewport transparente para ver el fondo
        sp.setOpaque(false); 
        sp.getViewport().setOpaque(false);
        
        panelTeclado = crearTeclado(); panelTeclado.setVisible(false);
        JPanel cont = new JPanel(new BorderLayout(8,0)); 
        cont.setOpaque(false); // Hacer transparente
        cont.add(sp, BorderLayout.CENTER); cont.add(panelTeclado, BorderLayout.EAST);
        ingreso.add(cont, BorderLayout.CENTER); ingreso.add(acciones, BorderLayout.SOUTH);
        tabbedPane.addTab("üî¢ Ingreso de Matriz", ingreso);

        // RESULTADOS: Sistema
        areaSistema = new JTextArea(); areaSistema.setEditable(false); areaSistema.setFont(new Font("Consolas",Font.PLAIN,13)); areaSistema.setForeground(TXT);
        JScrollPane spS = new JScrollPane(areaSistema);
        spS.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(S,2),"üìù Soluci√≥n (Ax=b)",0,2,new Font("Segoe UI",Font.BOLD,13),S));
        tabbedPane.addTab("üìù Soluci√≥n (Ax=b)", spS);

        // Inversa
        areaInversa = new JTextArea(); areaInversa.setEditable(false); areaInversa.setFont(new Font("Consolas",Font.PLAIN,13)); areaInversa.setForeground(TXT);
        JScrollPane spI = new JScrollPane(areaInversa);
        spI.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(I,2),"‚≠ê Detalle del Proceso y Matriz Inversa (A‚Åª¬π)",0,2,new Font("Segoe UI",Font.BOLD,13),I));
        tabbedPane.addTab("‚≠ê Inversa (A‚Åª¬π)", spI);

        // Historial
        JPanel ph = new JPanel(new BorderLayout(8,8)); 
        ph.setOpaque(false); // Hacer transparente
        String[] cols = {"ID","Tama√±o","Fecha y Hora","Matriz A","Vector b"};
        modeloHist = new DefaultTableModel(cols,0){ @Override public boolean isCellEditable(int r,int c){return false;} };
        tablaHist = new JTable(modeloHist); tablaHist.setFont(new Font("Segoe UI",Font.PLAIN,13)); tablaHist.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        JScrollPane sh = new JScrollPane(tablaHist);
        sh.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(H,2),"üìö Historial de C√°lculos",0,2,new Font("Segoe UI",Font.BOLD,13),H));
        ph.add(sh, BorderLayout.CENTER);
        JPanel btnHist = new JPanel(new FlowLayout(FlowLayout.CENTER,12,8)); 
        btnHist.setOpaque(false); // Hacer transparente
        btnEditarHistorial = btn("‚úèÔ∏è Editar/Cargar Matriz", S); btnEditarHistorial.addActionListener(a->editar()); btnEditarHistorial.setEnabled(false);
        btnBorrarHistorial = btn("üóëÔ∏è Borrar Selecci√≥n", DEL); btnBorrarHistorial.addActionListener(a->borrarHist()); btnBorrarHistorial.setEnabled(false);
        btnHist.add(btnEditarHistorial); btnHist.add(btnBorrarHistorial);
        ph.add(btnHist, BorderLayout.SOUTH);
        tablaHist.getSelectionModel().addListSelectionListener(e->{ boolean sel = tablaHist.getSelectedRow()!=-1; btnEditarHistorial.setEnabled(sel); btnBorrarHistorial.setEnabled(sel); });
        tabbedPane.addTab("üìö Historial", ph);

        // üÜï Agregar al mainPanel (el panel de fondo)
        mainPanel.add(tabbedPane, BorderLayout.CENTER);
        configurarCierreConTecla();
    }

    /* ---------- Helpers / UI builders ---------- */
    private JButton btn(String txt, Color bg){ JButton b = new JButton(txt); b.setFont(new Font("Segoe UI",Font.BOLD,13)); b.setBackground(bg); b.setForeground(Color.WHITE); b.setFocusPainted(false); b.setBorder(BorderFactory.createEmptyBorder(6,12,6,12)); return b; }

    private void initInputPanel(int n, JPanel cont){
        cont.removeAll(); camposEcu.clear(); camposB.clear();
        GridBagConstraints gbc = new GridBagConstraints(); gbc.insets = new Insets(5,5,5,17); gbc.fill = GridBagConstraints.HORIZONTAL;
        String[] vars = {"X","Y","Z","X4","X5","X6","X7","X8","X9","X10"};
        for (int j=0;j<n;j++){ gbc.gridx = j; gbc.gridy = 0; JLabel l = new JLabel(vars[j], SwingConstants.CENTER); l.setFont(new Font("Segoe UI",Font.BOLD,12)); l.setForeground(TXT); cont.add(l,gbc); }
        gbc.gridx = n+1; gbc.gridy = 0; JLabel lb = new JLabel("B", SwingConstants.CENTER); lb.setFont(new Font("Segoe UI",Font.BOLD,12)); lb.setForeground(S); cont.add(lb,gbc);

        FocusListener fl = new FocusAdapter(){ public void focusGained(FocusEvent e){ campoActivo = (JTextField)e.getComponent(); abrirTeclado(); } };
        KeyAdapter kl = new KeyAdapter(){ public void keyPressed(KeyEvent e){ if (e.getKeyCode()==KeyEvent.VK_ENTER){ transferir(); e.consume(); } } };

        for (int i=0;i<n;i++){
            List<JTextField> fila = new ArrayList<>();
            for (int j=0;j<n;j++){
                JTextField tf = new JTextField(10);
                tf.setFont(new Font("Consolas",Font.PLAIN,15)); tf.setHorizontalAlignment(JTextField.CENTER);
                tf.addFocusListener(fl); tf.addKeyListener(kl);
                gbc.gridx=j; gbc.gridy=i+1; cont.add(tf,gbc); fila.add(tf);
            }
            camposEcu.add(fila);
            gbc.gridx=n; gbc.gridy=i+1; JLabel eq = new JLabel("=", SwingConstants.CENTER); eq.setFont(new Font("Segoe UI",Font.BOLD,16)); cont.add(eq,gbc);
            JTextField tfB = new JTextField(10);
            tfB.setFont(new Font("Consolas",Font.PLAIN,15)); tfB.setHorizontalAlignment(JTextField.CENTER); tfB.setBackground(FB);
            tfB.addFocusListener(fl); tfB.addKeyListener(kl);
            gbc.gridx=n+1; cont.add(tfB,gbc); camposB.add(tfB);
        }
        cont.revalidate(); cont.repaint();
    }

    private void inicializarMatriz(int n){
        panelMatrizContainer.removeAll();
        JPanel p = new JPanel(new GridBagLayout()); 
        p.setOpaque(false); // Hacer transparente
        GridBagConstraints gbc = new GridBagConstraints(); gbc.insets = new Insets(10,10,10,10); gbc.fill = GridBagConstraints.BOTH;
        String[] vars = {"X","Y","Z","X4","X5","X6","X7","X8","X9","X10"};
        for (int j=0;j<n;j++){ gbc.gridx=j; gbc.gridy=0; JLabel l = new JLabel(vars[j], SwingConstants.CENTER); l.setFont(new Font("Segoe UI",Font.BOLD,13)); l.setForeground(TXT); p.add(l,gbc); }
        gbc.gridx = n+1; gbc.gridy=0; JLabel lb = new JLabel("T√©rminos independientes", SwingConstants.CENTER); lb.setFont(new Font("Segoe UI",Font.BOLD,13)); lb.setForeground(S); p.add(lb,gbc);
        campos = new JTextField[n][n+1];

        FocusListener fl = new FocusAdapter(){ public void focusGained(FocusEvent e){ campoActivo = (JTextField)e.getComponent(); abrirTeclado(); } };
        KeyAdapter kl = new KeyAdapter(){ public void keyPressed(KeyEvent e){ if (e.getKeyCode()==KeyEvent.VK_ENTER){ transferir(); e.consume(); } } };

        for (int i=0;i<n;i++){
            for (int j=0;j<n+1;j++){
                JTextField tf = new JTextField(9);
                tf.setHorizontalAlignment(JTextField.CENTER); tf.setFont(new Font("Consolas",Font.BOLD,12)); tf.setForeground(TXT);
                gbc.gridy = i+1;
                if (j<n){ gbc.gridx=j; p.add(tf,gbc); }
                else {
                    tf.setBackground(FB); gbc.gridx=n;
                    JLabel eq = new JLabel("=", SwingConstants.CENTER); eq.setFont(new Font("Segoe UI",Font.BOLD,16)); eq.setForeground(TXT); p.add(eq,gbc);
                    gbc.gridx=n+1; p.add(tf,gbc);
                }
                tf.addFocusListener(fl); tf.addKeyListener(kl);
                campos[i][j] = tf;
            }
        }
        panelMatrizContainer.add(p, new GridBagConstraints()); panelMatrizContainer.revalidate(); panelMatrizContainer.repaint();
    }

    /* ---------- Transfer / parsing / examples ---------- */
    private void transferir(){
        int n = nActual;
        try {
            for (int i=0;i<n;i++){
                for (int j=0;j<n;j++){
                    String t = camposEcu.get(i).get(j).getText().trim(); String v = t.isEmpty()? "0" : parseCoef(t);
                    campos[i][j].setText(v);
                }
                String tb = camposB.get(i).getText().trim(); String vb = tb.isEmpty()? "0" : tb;
                Double.parseDouble(vb); campos[i][n].setText(vb);
            }
        } catch (NumberFormatException ex){
            JOptionPane.showMessageDialog(this,"¬°ERROR! Formato inv√°lido. Usa solo n√∫meros v√°lidos o coeficientes simples.","Error",JOptionPane.ERROR_MESSAGE);
        } catch (Exception ex){
            JOptionPane.showMessageDialog(this,"Error inesperado al transferir: " + ex.getMessage(),"Error",JOptionPane.ERROR_MESSAGE);
        }
    }
    private String parseCoef(String t) throws NumberFormatException {
        try { Double.parseDouble(t); return t; } catch (NumberFormatException ignored) {}
        String c = t.toLowerCase().trim();
        if (c.matches("^[a-z].*")) return "1";
        if (c.matches("^\\-([a-z].*)$")) return "-1";
        String num = c.replaceAll("[a-z].*","").trim();
        if (num.isEmpty() || num.equals("+")) return "1";
        if (num.equals("-")) return "-1";
        Double.parseDouble(num);
        return num;
    }
    private void cargarEjemplo(boolean transfer){
        int n = nActual; double[][] ejemplo;
        if (n==3) ejemplo = new double[][]{{-1,1,1,1},{3,2,8,3},{9,5,7,9}};
        else { ejemplo = new double[n][n+1]; Random r = new Random(); for (int i=0;i<n;i++) for (int j=0;j<n+1;j++){ int num = r.nextInt(19)-9; if (num==0) num = r.nextBoolean()?1:-1; ejemplo[i][j] = num; } }
        DecimalFormat df = new DecimalFormat("0.#");
        if (nActual==n) limpiarCamposBasicos();
        for (int i=0;i<n;i++){
            for (int j=0;j<n;j++){
                double v = ejemplo[i][j]; String val = (Math.abs(v - Math.round(v))<1e-9)? String.valueOf((int)Math.round(v)) : df.format(v);
                camposEcu.get(i).get(j).setText(val);
            }
            double vb = ejemplo[i][n]; String valb = (Math.abs(vb - Math.round(vb))<1e-9)? String.valueOf((int)Math.round(vb)) : df.format(vb);
            camposB.get(i).setText(valb);
        }
        if (transfer) transferir();
    }

    /* ---------- C√°lculo Gauss-Jordan / Inversa / Mostrar ---------- */
    private void calcularAmbos(int tab){ resolverSistema(); resolverInversa(); tabbedPane.setSelectedIndex(tab+1); }
    private void resolverSistema(){
        int n = nActual; double[][] M = new double[n][n+1]; boolean b_vacio = true;
        try {
            for (int i=0;i<n;i++){
                for (int j=0;j<n;j++){ String t = campos[i][j].getText(); M[i][j] = t.isEmpty()?0.0:Double.parseDouble(t); }
                String tb = campos[i][n].getText(); double vb = tb.isEmpty()?0.0:Double.parseDouble(tb); M[i][n] = vb; if (Math.abs(vb)>TOL) b_vacio=false;
            }
        } catch (NumberFormatException ex){ areaSistema.setText("¬°ERROR! Formato inv√°lido en la matriz."); return; }
        if (b_vacio){ _calcularInversa(areaSistema, true); return; }
        double[][] copia = copiar(M); StringBuilder s = new StringBuilder();
        s.append("\n¬† Resolviendo Sistema (Ax=b)\n\n");
        s.append("Matriz Aumentada Inicial [A | b]:\n").append(matrizToString(copia,n)).append("\n");
        double[] sol = gaussJordan(copia,n,true,s);
        s.append("\n\n");
        if (sol!=null){ s.append("Matriz Final [I | Soluci√≥n]\n").append(matrizToString(copia,n)).append("\nSolutions:\n"); DecimalFormat df = new DecimalFormat("0.######"); for (int i=0;i<sol.length;i++) s.append("x").append(i+1).append(" = ").append(df.format(sol[i])).append("\n"); }
        else s.append("Sistema sin soluci√≥n √∫nica (inconsistente o infinitas soluciones).");
        areaSistema.setText(s.toString()); areaSistema.setCaretPosition(0);
    }
    private void resolverInversa(){ _calcularInversa(areaInversa, false); }
    private void _calcularInversa(JTextArea area, boolean aviso){
        int n = nActual; double[][] A = new double[n][2*n];
        try {
            for (int i=0;i<n;i++){ for (int j=0;j<n;j++){ String t = campos[i][j].getText(); A[i][j] = t.isEmpty()?0.0:Double.parseDouble(t); } A[i][n+i]=1.0; }
        } catch (NumberFormatException ex){ area.setText("¬°ERROR! Formato inv√°lido en A."); return; }
        StringBuilder s = new StringBuilder(); if (aviso) s.append("‚ö†Ô∏è C√ÅLCULO MODIFICADO: b vac√≠o -> calculando A‚Åª¬π\n\n");
        s.append("Matriz Aumentada Inicial [A | I]:\n").append(matrizToString(A,n)).append("\n");
        double[] res = gaussJordan(A,n,false,s);
        boolean exito = res!=null;
        s.append("\n\n");
        if (exito){ s.append("Matriz Final [I | A‚Åª¬π]\n").append(matrizToString(A,n)).append("\nMatriz Inversa:\n").append(extraerInversa(A,n)); }
        else s.append("Matriz no invertible (singular).");
        area.setText(s.toString()); area.setCaretPosition(0);
    }

    private double[] gaussJordan(double[][] M, int n, boolean sistema, StringBuilder proceso){
        DecimalFormat df = new DecimalFormat("0.");
        int cols = M[0].length;
        for (int k=0;k<n;k++){
            proceso.append("\n--- FASE ").append(k+1).append(" ---\n");
            int imax = k; for (int i=k+1;i<n;i++) if (Math.abs(M[i][k])>Math.abs(M[imax][k])) imax = i;
            if (imax!=k){ double[] tmp = M[k]; M[k]=M[imax]; M[imax]=tmp; proceso.append("Intercambio F").append(k+1).append(" <-> F").append(imax+1).append("\n").append(matrizToString(M,n)).append("\n"); }
            if (Math.abs(M[k][k])<TOL){ proceso.append("Matriz singular (pivote 0)\n"); return null; }
            double d = M[k][k];
            if (Math.abs(d-1.0)>TOL){ for (int j=k;j<cols;j++) M[k][j]/=d; proceso.append("Normalizar F").append(k+1).append("\n").append(matrizToString(M,n)).append("\n"); }
            for (int i=0;i<n;i++) if (i!=k){
                double f = M[i][k];
                if (Math.abs(f)>TOL){ for (int j=k;j<cols;j++) M[i][j]-=f*M[k][j]; proceso.append("F").append(i+1).append(" -= ").append(df.format(f)).append("*F").append(k+1).append("\n").append(matrizToString(M,n)).append("\n"); }
            }
        }
        if (sistema){ double[] sol = new double[n]; for (int i=0;i<n;i++) sol[i]=M[i][n]; return sol; }
        return new double[n];
    }

    private double[][] copiar(double[][] orig){ double[][] c = new double[orig.length][orig[0].length]; for (int i=0;i<orig.length;i++) System.arraycopy(orig[i],0,c[i],0,orig[i].length); return c; }

    private String matrizToString(double[][] M, int n){
        StringBuilder sb = new StringBuilder(); DecimalFormat df = new DecimalFormat("0.#####");
        int cols = M[0].length; int w = 10;
        String sep = "+";
        for (int j=0;j<cols;j++){ sep += String.format("%" + w + "s","").replace(' ','-'); sep += (j==cols-1?"+":"+"); }
        for (int i=0;i<n;i++){
            sb.append(sep).append("\n|");
            for (int j=0;j<cols;j++){
                double v = Math.abs(M[i][j])<TOL?0.0:M[i][j];
                String val = df.format(v);
                sb.append(String.format("%" + w + "s", val));
                if (j==n-1 && cols==n+1) sb.append(" |"); else if (j==n-1 && cols==2*n) sb.append(" ||"); else sb.append("|");
            }
            sb.append("\n");
        }
        sb.append(sep).append("\n");
        return sb.toString();
    }
    private String extraerInversa(double[][] M, int n){
        StringBuilder sb = new StringBuilder(); DecimalFormat df = new DecimalFormat("0.#####"); int w = 10;
        String sep = "+"; for (int j=n;j<2*n;j++) sep += String.format("%" + w + "s","").replace(' ','-') + "+";
        for (int i=0;i<n;i++){ sb.append(sep).append("\n|"); for (int j=n;j<2*n;j++){ double v = Math.abs(M[i][j])<TOL?0.0:M[i][j]; sb.append(String.format("%" + w + "s", df.format(v))).append("|"); } sb.append("\n"); }
        sb.append(sep).append("\n"); return sb.toString();
    }

    /* ---------- Historial ---------- */
    private void guardarHist(){
        int n = nActual; double[][] mat = new double[n][n+1];
        try { for (int i=0;i<n;i++) for (int j=0;j<n+1;j++){ String t = campos[i][j].getText(); mat[i][j] = t.isEmpty()?0.0:Double.parseDouble(t); } }
        catch (NumberFormatException ex){ return; }
        MatrizHistorial r = new MatrizHistorial(mat,n,new Date()); historial.add(r); agregarFilaHist(r);
    }
    private void agregarFilaHist(MatrizHistorial r){
        String ma = r.matrizToString(0,r.getTamano()); String vb = r.matrizToString(r.getTamano(),1);
        Vector<Object> fila = new Vector<>(); fila.add(historial.size()); fila.add(r.getTamano()+"x"+r.getTamano());
        fila.add(new SimpleDateFormat("dd/MM/yy hh:mm:ss a").format(r.getFecha())); fila.add(ma); fila.add(vb);
        modeloHist.addRow(fila);
    }
    private void editar(){
        int f = tablaHist.getSelectedRow(); if (f==-1) return;
        MatrizHistorial r = historial.get(f); int n = r.getTamano(); double[][] d = r.getMatriz();
        cmbTamano.setSelectedItem(n+"x"+n);
        for (List<JTextField> fila: camposEcu) for (JTextField c: fila) c.setText("");
        for (JTextField c: camposB) c.setText("");
        DecimalFormat df = new DecimalFormat("0.#####");
        for (int i=0;i<n;i++) for (int j=0;j<n+1;j++) campos[i][j].setText(df.format(d[i][j]));
        tabbedPane.setSelectedIndex(0);
        JOptionPane.showMessageDialog(this,"Matriz cargada de " + n + "x" + n + " en 'Ingreso de Matriz'.","Carga Exitosa",JOptionPane.INFORMATION_MESSAGE);
    }
    private void borrarHist(){
        int f = tablaHist.getSelectedRow(); if (f==-1) return;
        int c = JOptionPane.showConfirmDialog(this,"¬øSeguro que quieres eliminar este registro?","Confirmar",JOptionPane.YES_NO_OPTION);
        if (c==JOptionPane.YES_OPTION){ historial.remove(f); modeloHist.removeRow(f); for (int i=0;i<modeloHist.getRowCount();i++) modeloHist.setValueAt(i+1,i,0); JOptionPane.showMessageDialog(this,"Registro eliminado."); }
    }

    /* ---------- Teclado y navegaci√≥n ---------- */
    private JPanel crearTeclado(){
        Color KBG = new Color(33,33,33), KNUM = new Color(66,66,66), KOP = new Color(255,140,0);
        JPanel grid = new JPanel(new GridLayout(4,4,5,5)); grid.setBorder(BorderFactory.createEmptyBorder(8,8,8,8)); grid.setBackground(KBG);
        String[] keys = {"7","8","9","Borrar","4","5","6","+","1","2","3","-","0",".","ENTER","X"};
        Font f = new Font("Segoe UI",Font.BOLD,18);
        ActionListener al = e -> {
            String cmd = e.getActionCommand(); JTextField c = campoActivo;
            if (c==null){ if (!camposEcu.isEmpty() && !camposEcu.get(0).isEmpty()) { camposEcu.get(0).get(0).requestFocusInWindow(); c = campoActivo; } if (c==null) return; }
            String s = c.getText(); int p = c.getCaretPosition();
            try {
                if (cmd.matches("[0-9]")){ c.setText(s.substring(0,p)+cmd+s.substring(p)); c.setCaretPosition(p+1); SwingUtilities.invokeLater(this::navegarSiguiente); return; }
                if (".".equals(cmd)){ if (!s.contains(".")){ c.setText(s.substring(0,p)+"."+s.substring(p)); c.setCaretPosition(p+1); SwingUtilities.invokeLater(this::navegarSiguiente); } return; }
                if ("+".equals(cmd) || "-".equals(cmd)){ if (s.isEmpty() && p==0){ c.setText(cmd); c.setCaretPosition(1); } return; }
                if ("Borrar".equals(cmd)){ if (p>0){ c.setText(s.substring(0,p-1)+s.substring(p)); c.setCaretPosition(p-1); } return; }
                if ("ENTER".equals(cmd)){ panelTeclado.setVisible(false); transferir(); return; }
                if ("X".equals(cmd)){ panelTeclado.setVisible(false); return; }
            } catch (Exception ignored) {}
            c.requestFocusInWindow();
        };
        for (String k: keys){ JButton b = new JButton(k); b.setFont(f); b.setFocusPainted(false); b.addActionListener(al);
            if (k.matches("[0-9]")||k.equals(".")){ b.setBackground(KNUM); b.setForeground(Color.WHITE); }
            else if ("ENTER".equals(k)){ b.setBackground(KOP); b.setForeground(Color.WHITE); }
            else if ("Borrar".equals(k)){ b.setBackground(KOP.darker()); b.setForeground(Color.WHITE); }
            else { b.setBackground(KOP); b.setForeground(Color.WHITE); }
            grid.add(b);
        }
        JPanel cont = new JPanel(new BorderLayout()); cont.setOpaque(false);
        JPanel footer = new JPanel(new FlowLayout(FlowLayout.CENTER,8,6)); footer.setOpaque(false);
        JButton left = new JButton("‚Üê"), right = new JButton("‚Üí"); left.setPreferredSize(new Dimension(46,28)); right.setPreferredSize(new Dimension(46,28));
        left.setBackground(S); left.setForeground(Color.WHITE); right.setBackground(S); right.setForeground(Color.WHITE);
        left.setFocusPainted(false); right.setFocusPainted(false);
        left.addActionListener(e->{ SwingUtilities.invokeLater(()->{ Component o = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner(); if (o instanceof JTextField) campoActivo = (JTextField)o; navegarAnterior(); Component n = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner(); if (n instanceof JTextField){ campoActivo=(JTextField)n; campoActivo.requestFocusInWindow(); campoActivo.selectAll(); } });});
        right.addActionListener(e->{ SwingUtilities.invokeLater(()->{ Component o = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner(); if (o instanceof JTextField) campoActivo = (JTextField)o; navegarSiguiente(); Component n = KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner(); if (n instanceof JTextField){ campoActivo=(JTextField)n; campoActivo.requestFocusInWindow(); campoActivo.selectAll(); } });});
        footer.add(left); footer.add(right);
        cont.add(grid, BorderLayout.CENTER); cont.add(footer, BorderLayout.SOUTH);
        cont.setBorder(BorderFactory.createTitledBorder(BorderFactory.createLineBorder(P,1),"‚å®Ô∏è Teclado Num√©rico Fijo",0,2,new Font("Segoe UI",Font.BOLD,13),P));
        cont.setOpaque(false); // Hacer transparente
        cont.setPreferredSize(new Dimension(280,340));
        return cont;
    }
    private void abrirTeclado(){ if (panelTeclado!=null) panelTeclado.setVisible(true); }

    private void navegarSiguiente(){
        if (campoActivo==null) return;
        int n = nActual;
        for (int i=0;i<n;i++){
            List<JTextField> fila = camposEcu.get(i);
            for (int j=0;j<n;j++) if (fila.get(j)==campoActivo){ if (j<n-1){ fila.get(j+1).requestFocusInWindow(); return; } else { camposB.get(i).requestFocusInWindow(); return; } }
            if (camposB.get(i)==campoActivo){ if (i<n-1){ camposEcu.get(i+1).get(0).requestFocusInWindow(); return; } }
        }
        int cols = n+1;
        for (int i=0;i<n;i++) for (int j=0;j<cols;j++) if (campos[i][j]==campoActivo){
            if (j<cols-1){ campos[i][j+1].requestFocusInWindow(); return; }
            else if (i<n-1){ campos[i+1][0].requestFocusInWindow(); return; }
            else { transferir(); if (panelTeclado!=null && panelTeclado.isVisible()) panelTeclado.setVisible(false); return; }
        }
        KeyboardFocusManager.getCurrentKeyboardFocusManager().focusNextComponent();
    }
    private void navegarAnterior(){
        if (campoActivo==null) return;
        int n = nActual, cols = n+1;
        for (int i=0;i<n;i++) for (int j=0;j<cols;j++) if (campos[i][j]==campoActivo){
            if (j>0){ campos[i][j-1].requestFocusInWindow(); return; }
            else if (i>0){ campos[i-1][cols-1].requestFocusInWindow(); return; }
            return;
        }
        for (int i=0;i<n;i++){
            List<JTextField> fila = camposEcu.get(i);
            for (int j=0;j<n;j++) if (fila.get(j)==campoActivo){
                if (j>0){ fila.get(j-1).requestFocusInWindow(); return; }
                else if (i>0){ camposB.get(i-1).requestFocusInWindow(); return; }
                return;
            }
            if (camposB.get(i)==campoActivo){ fila.get(n-1).requestFocusInWindow(); return; }
        }
    }

    private void limpiarCamposBasicos(){ for (List<JTextField> f: camposEcu) for (JTextField c: f) c.setText(""); for (JTextField c: camposB) c.setText(""); }
    private void limpiar(){ for (int i=0;i<nActual;i++) for (int j=0;j<nActual+1;j++) campos[i][j].setText(""); limpiarCamposBasicos(); areaSistema.setText(""); areaInversa.setText(""); tabbedPane.setSelectedIndex(0); campoActivo=null; if (panelTeclado!=null) panelTeclado.setVisible(false); }
    private void cambiarTamano(){ String sel = (String)cmbTamano.getSelectedItem(); int nuevo = Integer.parseInt(sel.substring(0,sel.indexOf('x'))); if (nuevo!=nActual){ nActual = nuevo; if (ecuacionPanel!=null) initInputPanel(nActual, ecuacionPanel); inicializarMatriz(nActual); } }
    private void configurarCierreConTecla(){ InputMap im = getRootPane().getInputMap(JComponent.WHEN_IN_FOCUSED_WINDOW); KeyStroke k = KeyStroke.getKeyStroke(KeyEvent.VK_MULTIPLY,0); im.put(k,"cerrar"); getRootPane().getActionMap().put("cerrar", new AbstractAction(){ public void actionPerformed(ActionEvent e){ dispose(); }}); }

    /* ---------- Inner classes ---------- */
    private static class MatrizHistorial {
        private final double[][] mat; private final int tam; private final Date fecha;
        public MatrizHistorial(double[][] m, int t, Date f){ tam=t; fecha=f; mat=new double[t][t+1]; for (int i=0;i<t;i++) System.arraycopy(m[i],0,mat[i],0,t+1); }
        public double[][] getMatriz(){ return mat; } public int getTamano(){ return tam; } public Date getFecha(){ return fecha; }
        public String matrizToString(int startCol, int width){
            StringBuilder sb = new StringBuilder(); DecimalFormat df = new DecimalFormat("0.##");
            for (int i=0;i<tam;i++){ sb.append("["); for (int j=0;j<width;j++){ double v = mat[i][startCol+j]; sb.append(df.format(v)); if (j<width-1) sb.append(", "); } sb.append("]"); if (i<tam-1) sb.append(" | "); }
            return sb.toString();
        }
    }

    public static void main(String[] args){
        SwingUtilities.invokeLater(() -> { 
            try { 
                // Usar Nimbus para un look moderno
                UIManager.setLookAndFeel("javax.swing.plaf.nimbus.NimbusLookAndFeel"); 
            } catch (Exception ignored){} 
            
            CalculadoraGaussJordanFinal app = new CalculadoraGaussJordanFinal(); 
            app.setVisible(true); 
        });
    }
}
